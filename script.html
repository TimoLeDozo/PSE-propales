<script>
const $ = id => document.getElementById(id);

/* ---------- helpers ---------- */
function showModal(title, status, pct = 0) {
  $('modalTitle').textContent   = title;
  $('modalStatus').textContent  = status;
  $('progressBar').style.width  = pct + '%';
  $('modalResult').innerHTML    = '';
  $('btnCloseModal').classList.add('hidden');
  $('modal').classList.remove('hidden');
}
function hideModal() { $('modal').classList.add('hidden'); }

/* ---------- collect ---------- */
function collectForm() {
  const fields = [
    'titre','codeProjet','dateDebut','versionDoc','dureeProjet','thematique',
    'entrepriseNom','entrepriseAdresse','clientNom','clientFonction','clientEmail','clientTelephone','entrepriseLogo',
    'contexte','demarche','phases','phrase'
  ];
  const out = {};
  fields.forEach(f => out[f] = $(`f_${f}`)?.value.trim() || '');
  return out;
}

/* ---------- main button ---------- */
$('btnGenerate').addEventListener('click', () => {
  const fd = collectForm();
  if (!fd.titre || !fd.entrepriseNom) {
    alert('âš ï¸ Titre et Entreprise sont obligatoires'); return;
  }
  showModal('ðŸš€ Lancement', 'Copie du modÃ¨leâ€¦', 15);

  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        showModal('ðŸŽ‰ SuccÃ¨s', 'Document crÃ©Ã©', 100);
        $('modalResult').innerHTML =
          `<a href="${res.url}" target="_blank" class="btn bg-indigo-600 hover:bg-indigo-700 mt-4 inline-block">ðŸ“„ Ouvrir le document</a>`;
      } else {
        showModal('âŒ Erreur', res.error || 'Erreur inconnue', 0);
      }
      $('btnCloseModal').classList.remove('hidden');
    })
    .withFailureHandler(err => {
      showModal('âŒ Erreur', err.message || String(err), 0);
      $('btnCloseModal').classList.remove('hidden');
    })
    .generateFromForm(fd);
});

$('btnCloseModal').addEventListener('click', hideModal);
$('modal').addEventListener('click', e => { if (e.target.id === 'modal') hideModal(); });
</script>