<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSI Propales ¬∑ Neural Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --gradient-primary: linear-gradient(135deg, #e0a3ff, #ff69b4, #00ffff);
      --glass-bg: rgba(255, 255, 255, 0.06);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
      --color-border: rgba(255, 255, 255, 0.16);
      --color-text: rgba(255, 255, 255, 0.94);
      --color-text-soft: rgba(255, 255, 255, 0.75);
      --color-text-muted: rgba(255, 255, 255, 0.55);
      --focus-ring: 0 0 0 3px rgba(0, 255, 255, 0.25);
      --transition-base: 0.3s ease;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #050505;
      color: #f2e7ff;
      overflow-x: hidden;
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    a { color: inherit; }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .neural-background {
      position: fixed;
      inset: 0;
      z-index: -3;
      background: radial-gradient(circle at 15% 85%, rgba(75, 0, 130, 0.7) 0%, transparent 55%),
        radial-gradient(circle at 85% 15%, rgba(139, 37, 99, 0.8) 0%, transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(0, 255, 255, 0.22) 0%, transparent 65%),
        linear-gradient(135deg, #050505 0%, #12051c 50%, #050505 100%);
      animation: backgroundPulse 16s ease-in-out infinite;
    }
    @keyframes backgroundPulse {
      0%, 100% { filter: brightness(0.92) saturate(1.4); }
      40% { filter: brightness(1.04) saturate(1.55) hue-rotate(10deg); }
      70% { filter: brightness(0.98) saturate(1.6) hue-rotate(-8deg); }
    }
    .geometric-shapes {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      pointer-events: none;
    }
    .shape {
      position: absolute;
      border: 1px solid rgba(0, 255, 255, 0.25);
      animation: floatShape 22s linear infinite;
      filter: drop-shadow(0 0 18px rgba(224, 163, 255, 0.35));
    }
    .shape:nth-child(1) { width: 110px; height: 110px; left: 8%; animation-delay: -2s; border-radius: 28px; }
    .shape:nth-child(2) { width: 70px; height: 70px; left: 76%; animation-delay: -9s; border-radius: 50%; border-color: rgba(255, 105, 180, 0.35); }
    .shape:nth-child(3) { width: 90px; height: 90px; left: 30%; animation-delay: -13s; transform: rotate(45deg); }
    .shape:nth-child(4) { width: 150px; height: 150px; left: 58%; animation-delay: -18s; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); background: linear-gradient(45deg, rgba(255, 0, 128, 0.12), transparent); }
    @keyframes floatShape {
      from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      15%, 85% { opacity: 1; }
      to { transform: translateY(-120px) rotate(360deg); opacity: 0; }
    }
    .neural-lines {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
    .neural-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 1px;
      opacity: 0.25;
      transform-origin: left;
      transition: transform 0.4s ease;
    }
    .neural-line:nth-child(1) { top: 22%; background: linear-gradient(90deg, transparent, #e0a3ff, transparent); }
    .neural-line:nth-child(2) { top: 52%; background: linear-gradient(90deg, transparent, #ff69b4, transparent); }
    .neural-line:nth-child(3) { top: 78%; background: linear-gradient(90deg, transparent, #00ffff, transparent); }
    @keyframes neuralPulse { 0%,100%{opacity:0.25;transform:scaleX(0.5);} 50%{opacity:1;transform:scaleX(1);} }

    header {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: min(1200px, 94vw);
      padding: 18px 30px;
      border-radius: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 30px;
      background: rgba(18, 18, 18, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(26px);
      transition: all 0.4s ease;
      z-index: 200;
    }
    header.scrolled {
      background: rgba(12, 12, 12, 0.85);
      border-color: rgba(224, 163, 255, 0.25);
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.45);
    }
    nav { display: contents; }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 0.28em;
      font-size: 0.95rem;
      text-decoration: none;
      text-transform: uppercase;
      color: #fefbff;
    }
    .icam-logo {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .icam-logo-custom {
      background-color: white;
      padding: 5px;
      border-radius: 5px;
      transform: scale(1.5);
    }
header .logo .icam-logo-custom {
  padding: 5px 10px;
  border-radius: 8px;
}
    .logo-icon {
  width: 56px;
      filter: drop-shadow(0 0 12px rgba(224, 163, 255, 0.65));
    }
    .nav-links {
      list-style: none;
      display: flex;
      gap: 10px;
      align-items: center;
      margin-left: auto;
    }
    .nav-links a {
      text-decoration: none;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 0.92rem;
      color: rgba(255, 255, 255, 0.88);
      transition: all 0.3s ease;
      position: relative;
    }
    .nav-links a::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(224, 163, 255, 0.18), rgba(0, 255, 255, 0.18));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
    }
    .nav-links a:hover::after,
    .nav-links a.active::after { opacity: 1; }
    .nav-links a.active { color: #ffffff; }
    .nav-links a.external-link::after { opacity: 0.45; }

    .mobile-menu-toggle {
      display: none;
      flex-direction: column;
      gap: 5px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .mobile-menu-toggle:hover { background: rgba(224, 163, 255, 0.2); }
    .hamburger-line { width: 24px; height: 2px; background: linear-gradient(90deg, #e0a3ff, #ff69b4); border-radius: 2px; transition: transform 0.3s ease, opacity 0.3s ease; }
    .mobile-menu-toggle.active .hamburger-line:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
    .mobile-menu-toggle.active .hamburger-line:nth-child(2) { opacity: 0; }
    .mobile-menu-toggle.active .hamburger-line:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
    .mobile-nav {
      position: fixed;
      top: 95px;
      left: 50%;
      transform: translateX(-50%);
      width: min(420px, 90vw);
      padding: 28px;
      border-radius: 24px;
      background: rgba(10, 10, 10, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 25px 55px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(22px);
      display: none;
      flex-direction: column;
      gap: 18px;
      z-index: 190;
    }
    .mobile-nav a {
      text-decoration: none;
      padding: 14px 18px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
    }
    .mobile-nav a:hover,
    .mobile-nav a.active { background: rgba(224, 163, 255, 0.15); border-color: rgba(224, 163, 255, 0.4); color: #fff; }
    .mobile-nav.active { display: flex; animation: slideDown 0.28s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }

    main { position: relative; padding-top: 140px; }
    .hero {
      min-height: 95vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 140px 20px 120px;
      position: relative;
    }
    .hero::before {
      content: '';
      position: absolute;
      inset: 20% 12% 10%;
      background: radial-gradient(circle, rgba(224, 163, 255, 0.1) 0%, transparent 70%);
      z-index: -1;
      animation: heroGlow 12s ease-in-out infinite;
    }
    @keyframes heroGlow { 0%,100%{transform:scale(1);opacity:0.6;} 50%{transform:scale(1.22);opacity:1;} }
    .hero-content { max-width: 960px; margin: 0 auto; }
    .hero-subtitle {
      text-transform: uppercase;
      letter-spacing: 0.5em;
      font-size: 0.75rem;
      color: rgba(224, 163, 255, 0.8);
      margin-bottom: 24px;
    }
    .hero h1 {
      font-size: clamp(2.2rem, 6vw, 4.4rem);
      font-weight: 800;
      background: linear-gradient(135deg, #e0a3ff, #ff69b4, #8ec5ff);
      background-size: 260% 260%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: modernGradient 8s ease infinite;
      margin-bottom: 28px;
    }
    @keyframes modernGradient { 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }
    .hero-description { max-width: 740px; margin: 0 auto 60px; color: rgba(255, 255, 255, 0.75); font-size: 1.05rem; }
    .hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 24px; margin: 0 auto 60px; max-width: 800px; }
    .hero-stat { position: relative; padding: 24px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(224, 163, 255, 0.2); box-shadow: 0 20px 45px rgba(0,0,0,0.3); backdrop-filter: blur(16px); transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease, z-index 0s; }
    .hero-stat:hover { box-shadow: 0 32px 60px rgba(0,0,0,0.55), 0 0 30px rgba(224, 163, 255, 0.25); background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.4); z-index: 10; }
    .hero-stat-number { font-size: 2.1rem; font-weight: 700; color: #ffffff; margin-bottom: 6px; }
    .hero-stat-label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.2em; color: rgba(255,255,255,0.65); }
    .cta-buttons { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .cta-button { display: inline-flex; align-items: center; gap: 10px; padding: 14px 34px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.85rem; transition: all 0.3s ease; text-decoration: none; }
    .cta-button.primary { background: var(--gradient-primary); color: #050505; box-shadow: 0 18px 35px rgba(224, 163, 255, 0.35); }
    .cta-button.secondary { background: rgba(255,255,255,0.04); color: #fff; border: 1px solid rgba(255,255,255,0.15); }
    .cta-button:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 25px 45px rgba(0,0,0,0.4); }

    .console-section {
      position: relative;
      padding: 160px 20px 140px;
    }
    .console-wrapper {
      width: min(1100px, 94vw);
      margin: 0 auto;
      display: grid;
      gap: 40px;
    }
    .console-layout {
      display: grid;
      gap: 32px;
      align-items: start;
    }
    .results-column {
      display: grid;
      gap: 28px;
      align-content: start;
    }
    .console-header { text-align: center; }
    .console-header h2 { font-size: clamp(2.2rem, 4vw, 3.1rem); margin-bottom: 16px; letter-spacing: -0.01em; }
    .console-header p { color: rgba(255, 255, 255, 0.7); max-width: 680px; margin: 0 auto; }
    .form-panels {
      display: grid;
      gap: 32px;
    }
    .glass-panel {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 28px;
      padding: 34px;
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(22px);
    }
    .insights-panel {
      background: var(--glass-bg);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 32px;
      padding: 40px 32px 32px;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(24px);
      display: grid;
      gap: 28px;
      position: relative;
      isolation: isolate;
    }
    .insights-panel::after {
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      pointer-events: none;
      z-index: -1;
    }
    .insights-pinned-header {
      position: sticky;
      top: 80px;
      z-index: 5;
      margin: -8px -8px 0;
      padding: 18px 22px;
      border-radius: 22px;
      background: rgba(8, 8, 8, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(18px);
      display: grid;
      gap: 6px;
    }
    .insights-pinned-header h3 {
      font-size: 1.2rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #fff;
      margin: 0;
    }
    .insights-pinned-header p {
      color: var(--color-text-muted);
      font-size: 0.92rem;
      margin: 0;
    }
    .insights-section { display: grid; gap: 14px; }
    .insights-section h4 {
      font-size: 0.82rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
    }
    .insights-section-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      flex-wrap: wrap;
    }
    .insights-section-heading h4 { margin: 0; }
    .insights-section-heading .console-open-button {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.04);
      color: #fff;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .insights-section-heading .console-open-button:hover:not(:disabled) {
      color: #00ffff;
      border-color: rgba(0, 255, 255, 0.6);
      background: rgba(0, 255, 255, 0.12);
    }
    .insights-section-heading .console-open-button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .insights-tips {
      list-style: none;
      display: grid;
      gap: 10px;
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding-left: 0;
      margin: 0;
    }
    .insights-tips li { display: flex; gap: 12px; align-items: flex-start; }
    .insights-tips li span:first-child { font-size: 1.1rem; }
    .generation-progress {
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 18px 20px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      color: var(--color-text-soft);
    }
    .generation-progress.is-active { display: flex; animation: fadeSlideIn 0.4s ease; }
    .generation-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
    }
    .generation-progress-message { color: var(--color-text-soft); }
    .generation-progress-percent {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #ffffff;
    }
    .generation-progress-bar {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }
    .generation-progress-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(127, 127, 255, 0.95), rgba(0, 255, 255, 0.85));
      transition: width 0.3s ease;
    }
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .console-header-top {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .console-logo-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: auto;
      padding: 0;
      padding-top: 10px;
      background: none;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
    }
    .console-logo {
      width: 130px;
      height: 75px;
      object-fit: contain;
      filter: drop-shadow(0 0 14px rgba(224, 163, 255, 0.6));
      transform: none;
      padding: 10px;
      border-radius: 12px;
      background: #ffffff;
    }

    .console-header .icam-logo-custom {
      transform: none;
    }
    .console-header p { max-width: 780px; margin: 0 auto; }
    .result-preview {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 18px;
      color: var(--color-text-muted);
      font-size: 0.92rem;
      line-height: 1.6;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .result-preview strong { color: var(--color-text); }
    .cost-log-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid rgba(0, 255, 255, 0.25);
      background: rgba(0, 255, 255, 0.12);
      color: #00ffff;
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    }
    .cost-log-link:hover { transform: translateY(-2px); box-shadow: 0 18px 40px rgba(0, 255, 255, 0.25); }
    .cost-log-link.is-disabled {
      opacity: 0.5;
      pointer-events: none;
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.6);
    }
    .files-hint {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.55);
      margin-top: 8px;
    }
    .field-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .field-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .dictation-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0, 255, 255, 0.4);
      background: rgba(0, 255, 255, 0.12);
      color: #00ffff;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .dictation-button:hover,
    .dictation-button:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.25);
      outline: none;
    }
    .dictation-button.is-active {
      background: rgba(0, 255, 200, 0.3);
      color: #041014;
      border-color: rgba(0, 255, 200, 0.7);
    }
    .dictation-button.is-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .dict-status {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(0, 255, 255, 0.75);
    }

    .dict-status:empty {
      display: none;
    }
    .form-note {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 6px;
    }
    .field input[type="file"] {
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.2);
      padding: 16px;
      cursor: pointer;
      background: rgba(6, 6, 6, 0.7);
    }
    .field input[type="file"]::-webkit-file-upload-button {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      padding: 10px 16px;
      margin-right: 12px;
      cursor: pointer;
    }
    .field input[type="file"]::file-selector-button {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      padding: 10px 16px;
      margin-right: 12px;
      cursor: pointer;
    }
    .result-status {
      padding: 18px 20px;
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.28);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      font-weight: 500;
      line-height: 1.5;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      transition: transform var(--transition-base), border-color var(--transition-base), background var(--transition-base);
    }
    .result-status span { flex: 1 1 auto; }
    .result-status a {
      color: #050505;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 14px;
      background: var(--gradient-primary);
      text-decoration: none;
      box-shadow: 0 20px 35px rgba(0,0,0,0.45);
      transition: transform var(--transition-base), box-shadow var(--transition-base);
    }
    .result-status a:hover,
    .result-status a:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 26px 45px rgba(0,0,0,0.55);
      outline: none;
      box-shadow: 0 26px 45px rgba(0,0,0,0.55), var(--focus-ring);
    }
    .result-status.is-idle { border-color: var(--color-border); background: rgba(255,255,255,0.04); }
    .result-status.is-progress { border-color: rgba(0, 247, 255, 0.45); background: rgba(0, 247, 255, 0.08); }
    .result-status.is-success { border-color: rgba(0, 255, 153, 0.45); background: rgba(0, 255, 153, 0.08); }
    .result-status.is-error { border-color: rgba(255, 105, 180, 0.5); background: rgba(255, 105, 180, 0.1); }
    .result-history {
      position: relative;
      list-style: none;
      display: grid;
      gap: 18px;
      margin: 0;
      padding-left: 0;
    }
    .insights-timeline::before {
      content: '';
      position: absolute;
      top: 12px;
      bottom: 0;
      left: 18px;
      width: 2px;
      background: linear-gradient(180deg, rgba(224, 163, 255, 0.7), rgba(0, 255, 255, 0.4));
      opacity: 0.65;
    }
    .result-item {
      position: relative;
      display: grid;
      gap: 6px;
      padding: 16px 18px 16px 56px;
      border-radius: 18px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--color-text-soft);
      font-size: 0.9rem;
      transition: transform var(--transition-base), border-color var(--transition-base), background var(--transition-base);
    }
    .result-item::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(0, 255, 255, 0.6);
      background: #050505;
      box-shadow: 0 0 0 4px rgba(0, 255, 255, 0.12);
    }
    .result-item.is-progress::before {
      border-color: rgba(0, 247, 255, 0.85);
      box-shadow: 0 0 0 4px rgba(0, 247, 255, 0.18);
    }
    .result-item.is-success::before {
      border-color: rgba(0, 255, 153, 0.85);
      box-shadow: 0 0 0 4px rgba(0, 255, 153, 0.18);
    }
    .result-item.is-error::before {
      border-color: rgba(255, 105, 180, 0.85);
      box-shadow: 0 0 0 4px rgba(255, 105, 180, 0.2);
    }
    .result-item span { color: var(--color-text-soft); }
    .result-item time {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }
    .result-item:hover { transform: translateY(-3px); border-color: rgba(0, 247, 255, 0.3); }
    .result-item.is-progress { border-color: rgba(0, 247, 255, 0.3); }
    .result-item.is-success { border-color: rgba(0, 255, 153, 0.35); }
    .result-item.is-error { border-color: rgba(255, 105, 180, 0.35); }
    .panel-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 24px; letter-spacing: 0.04em; display: flex; align-items: center; gap: 10px; color: #fff; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px 22px; }
    .field label { display: block; margin-bottom: 8px; font-size: 0.78rem; letter-spacing: 0.14em; color: rgba(255, 255, 255, 0.65); text-transform: uppercase; }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(6, 6, 6, 0.75);
      color: #ffffff;
      font-size: 0.95rem;
      font-weight: 500;
      transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      resize: vertical;
      min-height: 52px;
    }
    .field textarea { min-height: 120px; }
    .field select { appearance: none; cursor: pointer; }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: rgba(0, 255, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.25);
      background: rgba(12, 12, 12, 0.9);
    }
    .grid-span-2 { grid-column: span 2; }
    .actions { text-align: center; display: grid; gap: 16px; margin-top: 20px; }
    .action-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 14px; }
    .secondary-button {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 999px;
      padding: 16px 28px;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.45);
    }
    .secondary-button:hover,
    .secondary-button.active {
      transform: translateY(-3px);
      background: rgba(0, 255, 255, 0.12);
      box-shadow: 0 28px 46px rgba(0, 0, 0, 0.55);
    }
    #btnGenerate { background: var(--gradient-primary); color: #050505; border: none; border-radius: 999px; padding: 18px 34px; font-weight: 700; font-size: 0.95rem; letter-spacing: 0.12em; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 22px 50px rgba(0, 0, 0, 0.55); }
    #btnGenerate:hover { transform: translateY(-5px); box-shadow: 0 32px 60px rgba(0, 0, 0, 0.6); }
    .console-header .microcopy { font-size: 0.75rem; color: rgba(255, 255, 255, 0.45); letter-spacing: 0.1em; text-transform: uppercase; margin-top: 12px; }

    .showcase, footer { position: relative; }
    .section-title { font-size: clamp(2.2rem, 4vw, 3.2rem); text-align: center; margin-bottom: 80px; letter-spacing: 0.02em; }
    .showcase { padding: 140px 20px; }
    .hexagon-container { display: flex; flex-wrap: wrap; gap: 28px; justify-content: center; }
    .hexagon { width: 210px; height: 260px; position: relative; transition: transform 0.8s ease, opacity 0.8s ease; }
    .hexagon-bg { position: absolute; inset: 0; border-radius: 26px; transform: rotate(0deg); background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); backdrop-filter: blur(18px); transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease, border-color 0.4s ease; box-shadow: var(--glass-shadow); z-index: 1; }
    .hexagon-content { position: absolute; inset: 0; padding: 40px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; text-align: center; z-index: 2; pointer-events: none; }
    .hexagon:hover { z-index: 10; }
    .hexagon:hover .hexagon-bg { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); box-shadow: 0 40px 70px rgba(0, 0, 0, 0.55), 0 0 20px rgba(224, 163, 255, 0.25); }
    .hexagon-icon { font-size: 2.6rem; width: 100%; text-align: center; }
    .hexagon h4 { font-size: 1.2rem; text-align: center; margin: 0; }
    .hexagon p { color: rgba(255, 255, 255, 0.65); font-size: 0.9rem; text-align: center; margin: 0; text-wrap: balance; }


    footer { padding: 80px 20px; background: rgba(0, 0, 0, 0.5); border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .footer-content { width: min(1100px, 94vw); margin: 0 auto; display: grid; gap: 24px; text-align: center; color: rgba(255, 255, 255, 0.65); }
    .footer-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 18px; }
    .footer-links a { text-decoration: none; font-size: 0.85rem; color: rgba(255,255,255,0.6); transition: color 0.3s ease; }
    .footer-links a:hover { color: #fff; }

    #modal {
      position: fixed;
      inset: 0;
      background: rgba(5, 5, 12, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      backdrop-filter: blur(8px);
      padding: 20px;
    }
    #modal.active { display: flex; }
    .modal-card {
      width: min(420px, 92vw);
      background: rgba(12, 12, 12, 0.9);
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.55);
      padding: 32px;
      color: #fff;
      display: grid;
      gap: 18px;
    }
    .modal-progress { width: 100%; height: 10px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow: hidden; }
    .modal-progress-bar { width: 0%; height: 100%; border-radius: 999px; background: linear-gradient(90deg, #00ffff, #ff69b4); transition: width 0.2s ease; }
    .modal-actions { display: flex; justify-content: flex-end; }
    #btnCloseModal { padding: 12px 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.08); color: #fff; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: none; }
    #btnCloseModal:hover { background: rgba(224,163,255,0.25); }
    .modal-result a { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 16px; background: linear-gradient(135deg, #6a5bff, #00ffff); color: #050505; font-weight: 600; text-decoration: none; margin-top: 10px; }

    .llm-console-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 350;
      backdrop-filter: blur(10px);
    }
    .llm-console-overlay.active { display: flex; }
    .llm-console-card {
      width: min(960px, 94vw);
      max-height: 90vh;
      background: rgba(10, 10, 10, 0.96);
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 40px 120px rgba(0, 0, 0, 0.65);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .llm-console-header {
      padding: 22px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .llm-console-header h3 {
      margin: 0;
      font-size: 0.92rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .llm-console-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .llm-console-actions a,
    .llm-console-actions button {
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.04);
      color: #fff;
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }
    .llm-console-actions a:hover,
    .llm-console-actions button:hover {
      color: #00ffff;
      border-color: rgba(0, 255, 255, 0.6);
    }
    .llm-console-actions a.is-disabled { opacity: 0.4; pointer-events: none; }
    .llm-console-body {
      padding: 24px 28px;
      overflow: auto;
      font-family: 'JetBrains Mono', 'Fira Code', 'SFMono-Regular', Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.55;
      white-space: pre-wrap;
    }

    @media (min-width: 1100px) {
      .console-layout { grid-template-columns: minmax(0, 1.7fr) minmax(0, 1fr); }
      .results-column { position: sticky; top: 140px; }
    }
    @media (max-width: 900px) {
      .console-layout { gap: 28px; }
      .results-column { order: 2; }
      .insights-panel { padding: 30px; gap: 24px; }
      .insights-section h4 { letter-spacing: 0.12em; }
      .console-logo-wrapper {
        width: clamp(88px, 26vw, 120px);
        padding: 6px;
      }
    }
    @media (max-width: 620px) {
      .insights-timeline::before { left: 14px; }
      .result-item { padding: 16px 16px 16px 48px; }
      .result-item::before { left: 4px; }
    }
    @media (max-width: 1000px) {
      .nav-links { display: none; }
      .mobile-menu-toggle { display: flex; }
    }
    @media (max-width: 768px) {
      header { padding: 14px 20px; }
      .hero { padding-top: 160px; }
      .hero h1 { font-size: clamp(2rem, 8vw, 3.4rem); }
      .hero-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .grid-span-2 { grid-column: span 1; }
    }
    @media (max-width: 540px) {
      header { width: 96vw; }
      .console-wrapper { gap: 28px; }
      .glass-panel { padding: 26px; }
      .hexagon { width: 240px; height: 300px; }
      .console-logo-wrapper { width: clamp(76px, 32vw, 96px); padding: 6px; }
    }
    ::-webkit-scrollbar { width: 12px; }
    ::-webkit-scrollbar-track { background: rgba(8, 8, 8, 0.85); }
    ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #00ffff, #ff0080); border-radius: 6px; }
  </style>
</head>
<body>
  <div class="neural-background"></div>
  <div class="geometric-shapes">
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
  </div>
  <div class="neural-lines">
    <div class="neural-line"></div>
    <div class="neural-line"></div>
    <div class="neural-line"></div>
  </div>

  <header class="glass">
    <nav>
      <a href="#home" class="logo">
        <img class="icam-logo logo-icon icam-logo-custom" src="https://upload.wikimedia.org/wikipedia/fr/thumb/1/1d/Logo_ICAM_-_2008.svg/1200px-Logo_ICAM_-_2008.svg.png" alt="Icam" data-icam-logo data-fallback-logo="https://www.icam.fr/wp-content/uploads/2017/08/logo-icam-2.png" />
        <span class="sr-only">Icam Propales</span>
      </a>
      <ul class="nav-links">
        <li><a href="#console" class="active">Console</a></li>
        <li><a href="#showcase">Matrix</a></li>
        <li><a href="https://github.com/TimoLeDozo/PSE-propales" target="_blank" class="external-link" rel="noopener">GitHub</a></li>
      </ul>
      <div class="mobile-menu-toggle" aria-label="Menu">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
      </div>
    </nav>
    <div class="mobile-nav">
      <a href="#console" class="active">Console</a>
      <a href="#showcase">Matrix</a>
      <a href="https://github.com/TimoLeDozo/PSE-propales" target="_blank" class="external-link" rel="noopener">GitHub</a>
    </div>
  </header>

  <main>
    <section class="hero" id="home">
      <div class="hero-content">
        <div class="hero-subtitle">Propales instantan√©es</div>
        <h1>NEURAL PROPALE ENGINE</h1>
        <div class="hero-description">
          <p>Alimentez DeepSeek, d√©clenchez la duplication Drive et produisez vos propositions en un √©clair, sans compromis sur l'√©l√©gance, avec la rigueur Icam.</p>
        </div>
        <div class="hero-stats">
          <div class="hero-stat">
            <span class="hero-stat-number">60s</span>
            <span class="hero-stat-label">Document pr√™t</span>
          </div>
          <div class="hero-stat">
            <span class="hero-stat-number">100%</span>
            <span class="hero-stat-label">Color mapping</span>
          </div>
          <div class="hero-stat">
            <span class="hero-stat-number">‚àû</span>
            <span class="hero-stat-label">DeepSeek Access</span>
          </div>
          <div class="hero-stat">
            <span class="hero-stat-number">1</span>
            <span class="hero-stat-label">Clic n√©cessaire</span>
          </div>
        </div>
        <div class="cta-buttons">
          <a href="#console" class="cta-button primary">Initier la console</a>
          <a href="#showcase" class="cta-button secondary">D√©couvrir les flux</a>
        </div>
      </div>
    </section>

        <section class="console-section" id="console">
      <div class="console-wrapper">
        <div class="console-header">
          <div class="console-header-top">
            <div class="console-logo-wrapper">
              <img class="icam-logo console-logo icam-logo-custom" src="https://upload.wikimedia.org/wikipedia/fr/thumb/1/1d/Logo_ICAM_-_2008.svg/1200px-Logo_ICAM_-_2008.svg.png" alt="Icam" data-icam-logo data-fallback-logo="https://www.icam.fr/wp-content/uploads/2017/08/logo-icam-2.png" />
            </div>
            <div class="console-header-text">
              <h2>Console Neural ¬∑ G√©n√©ration de propale</h2>
              <p>Renseignez les zones cl√©s. Toutes les informations sont transmises √† Apps Script qui orchestre la copie du template Google Docs, le remplissage des zones surlign√©es et l'appel √† DeepSeek.</p>
              <p class="microcopy">Les donn√©es sont journalis√©es pour le suivi des co√ªts DeepSeek.</p>
            </div>
          </div>
        </div>
        <div class="console-layout">
          <div class="form-panels">
            <div class="glass-panel">
              <div class="panel-title">üìã Informations projet</div>
              <div class="form-grid">
                <div class="field grid-span-2"><label for="f_titre">Titre *</label><input id="f_titre" type="text" placeholder="Optimisation flux entrep√¥t" required></div>
                <div class="field"><label for="f_codeProjet">Code projet</label><input id="f_codeProjet" type="text" placeholder="144-16"></div>
                <div class="field"><label for="f_dateDebut">Date d√©but</label><input id="f_dateDebut" type="date"></div>
                <div class="field"><label for="f_versionDoc">Version</label><input id="f_versionDoc" type="text" placeholder="V1"></div>
                <div class="field"><label for="f_dureeProjet">Dur√©e</label><input id="f_dureeProjet" type="text" placeholder="6 mois"></div>
                <div class="field"><label for="f_thematique">Th√©matique</label><input id="f_thematique" type="text" placeholder="Logistique / Supply-chain"></div>
              </div>
            </div>
            <div class="glass-panel">
              <div class="panel-title">üè¢ Entreprise & Contact</div>
              <div class="form-grid">
                <div class="field"><label for="f_entrepriseNom">Entreprise *</label><input id="f_entrepriseNom" type="text" placeholder="Velibor SA" required></div>
                <div class="field"><label for="f_entrepriseAdresse">Adresse</label><input id="f_entrepriseAdresse" type="text" placeholder="49 bis rue Sedaine, 75011 Paris"></div>
                <div class="field"><label for="f_clientNom">Nom contact</label><input id="f_clientNom" type="text" placeholder="Jean Dupont"></div>
                <div class="field"><label for="f_clientFonction">Fonction</label><input id="f_clientFonction" type="text" placeholder="Directeur Technique"></div>
                <div class="field"><label for="f_clientEmail">Email</label><input id="f_clientEmail" type="email" placeholder="jean@exemple.com"></div>
                <div class="field"><label for="f_clientTelephone">T√©l√©phone</label><input id="f_clientTelephone" type="tel" placeholder="01 23 45 67 89"></div>
              </div>
            </div>
            <div class="glass-panel">
              <div class="panel-title">üß† Brief pour DeepSeek</div>
              <div class="form-grid">
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_ia_probleme">Probl√®me principal *</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_ia_probleme">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_ia_probleme"></span>
                    </div>
                  </div>
                  <textarea id="f_ia_probleme" placeholder="Retards de livraison, manque de tra√ßabilit√©‚Ä¶"></textarea>
                </div>
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_ia_solution">Solution propos√©e</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_ia_solution">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_ia_solution"></span>
                    </div>
                  </div>
                  <textarea id="f_ia_solution" placeholder="5S, outil de tracking, formation √©quipes‚Ä¶"></textarea>
                </div>
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_ia_objectifs">Objectifs cl√©s</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_ia_objectifs">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_ia_objectifs"></span>
                    </div>
                  </div>
                  <textarea id="f_ia_objectifs" placeholder="R√©duire de 20% les temps de pr√©paration, etc."></textarea>
                </div>
              </div>
            </div>
            <div class="glass-panel">
              <div class="panel-title">ü§ñ Sections g√©n√©r√©es par DeepSeek</div>
              <div class="form-grid">
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_contexte">Contexte</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_contexte">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_contexte"></span>
                    </div>
                  </div>
                  <textarea id="f_contexte" placeholder="(G√©n√©r√© / √âdition manuelle possible)"></textarea>
                </div>
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_demarche">D√©marche</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_demarche">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_demarche"></span>
                    </div>
                  </div>
                  <textarea id="f_demarche" placeholder="(G√©n√©r√© / √âdition manuelle possible)"></textarea>
                </div>
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_phases">Phases</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_phases">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_phases"></span>
                    </div>
                  </div>
                  <textarea id="f_phases" placeholder="(G√©n√©r√© / √âdition manuelle possible)"></textarea>
                </div>
                <div class="field grid-span-2">
                  <div class="field-header">
                    <label for="f_phrase">Phrase de cl√¥ture</label>
                    <div class="field-actions">
                      <button type="button" class="dictation-button" data-dict-target="f_phrase">üéôÔ∏è Dicter</button>
                      <span class="dict-status" data-dict-status="f_phrase"></span>
                    </div>
                  </div>
                  <textarea id="f_phrase" rows="2" placeholder="(G√©n√©r√© / √âdition manuelle possible)"></textarea>
                </div>
                <!-- ‚ö†Ô∏è Test hors Apps Script (CI): l'environnement ne fournit pas google.script.run, pr√©voir une v√©rification manuelle via l'√©diteur Apps Script pour confirmer la recopie multi-paragraphe. -->
              </div>
              <div class="actions">
                <div class="action-buttons">
                  <button type="button" id="btnGenerate">‚ú® G√©n√©rer la propale</button>
                </div>
              </div>
            </div>
            <div class="glass-panel">
              <div class="panel-title">üìé Pi√®ces jointes & outils</div>
              <div class="form-grid">
                <div class="field grid-span-2">
                  <label for="f_attachments">Ajouter des documents (jusqu‚Äô√† 15)</label>
                  <input id="f_attachments" type="file" multiple accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.jpeg,.jpg,.png,.mp3,.mp4" data-max="15">
                  <p class="files-hint" id="filesHint">Aucun fichier s√©lectionn√© (0/15).</p>
                </div>
              </div>
            </div>
          </div>
          <aside class="results-column">
            <section class="insights-panel">
              <div class="insights-pinned-header">
                <h3>üìü Pilotage & journalisation</h3>
                <p>Suivez l‚Äô√©tat de la g√©n√©ration, le suivi des co√ªts et les derniers √©v√®nements.</p>
              </div>
              <div class="insights-section">
                <div class="insights-section-heading">
                  <h4>Statut en direct</h4>
                  <button type="button" class="console-open-button" data-open-llm-console disabled>Console IA</button>
                </div>
                <div class="result-status is-idle" id="resultStatus"><span>En attente d‚Äôune g√©n√©ration.</span></div>
                <div class="generation-progress" id="generationProgress" aria-hidden="true">
                  <div class="generation-progress-header">
                    <span class="generation-progress-message" id="generationProgressMessage">Pr√©paration‚Ä¶</span>
                    <span class="generation-progress-percent" id="generationProgressPercent">0%</span>
                  </div>
                  <div class="generation-progress-bar" id="generationProgressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                    <div class="generation-progress-bar-fill" id="generationProgressFill"></div>
                  </div>
                </div>
              </div>
              <div class="insights-section">
                <div class="insights-section-heading">
                  <h4>Pr√©visualisation</h4>
                  <a id="costLogLink" class="cost-log-link is-disabled" href="#" target="_blank" rel="noopener" aria-disabled="true">üìä Journal des co√ªts</a>
                </div>
                <pre id="resultPreview" class="result-preview">Pr√™t √† compiler les informations du brief.</pre>
              </div>
              <div class="insights-section">
                <h4>Historique des actions</h4>
                <ol id="resultHistory" class="result-history insights-timeline">
                  <li class="result-item is-idle" data-placeholder="true"><span>Historique vide pour le moment.</span><time datetime=""></time></li>
                </ol>
              </div>
              <div class="insights-section">
                <h4>Conseils rapides</h4>
                <ul class="insights-tips">
                  <li><span aria-hidden="true">üßæ</span><span>Pr√©cisez le probl√®me principal pour guider DeepSeek.</span></li>
                  <li><span aria-hidden="true">üìé</span><span>Ajoutez des documents cl√©s pour la mise en contexte.</span></li>
                  <li><span aria-hidden="true">üìä</span><span>Consultez le journal Google Sheets pour suivre les co√ªts.</span></li>
                </ul>
              </div>
            </section>
          </aside>
        </div>
      </div>
    </section>


    

    <section class="showcase" id="showcase">
      <h2 class="section-title">Matrix Protocols</h2>
      <div class="hexagon-container">
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">üîÆ</div><h4>Holographic UI</h4><p>Interface monofichier pr√™te pour Apps Script</p></div></div>
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">üõ°Ô∏è</div><h4>Quantum Security</h4><p>Cl√© DeepSeek stock√©e c√¥t√© serveur</p></div></div>
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">üöÄ</div><h4>Speed Navigation</h4><p>Acc√®s direct au document g√©n√©r√©</p></div></div>
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">üíé</div><h4>Crystal Storage</h4><p>Copie organis√©e dans Drive cible</p></div></div>
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">üéØ</div><h4>Neural Targeting</h4><p>Color mapping intelligent</p></div></div>
        <div class="hexagon"><div class="hexagon-bg"></div><div class="hexagon-content"><div class="hexagon-icon">‚≠ê</div><h4>Stellar Network</h4><p>Workflow collaboratif Icam</p></div></div>
      </div>
    </section>

  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a href="#console">Console</a>
        <a href="#showcase">Matrix Protocols</a>
        <a href="https://github.com/TimoLeDozo/PSE-propales" target="_blank" rel="noopener">GitHub</a>
      </div>
      <div>&copy; 2025 MSI Propales ¬∑ Interface Apps Script</div>
      <div>CAGIN Timoth√© - VELOSO Toni </div>
    </div>
  </footer>

  <div class="llm-console-overlay" id="llmConsole" aria-hidden="true">
    <div class="llm-console-card" role="dialog" aria-labelledby="llmConsoleTitle">
      <div class="llm-console-header">
        <h3 id="llmConsoleTitle">Console IA ¬∑ transcript brut</h3>
        <div class="llm-console-actions">
          <a href="#" id="llmConsoleDocLink" class="is-disabled" target="_blank" rel="noopener" aria-disabled="true">Ouvrir dans Google Docs</a>
          <button type="button" id="llmConsoleClose">Fermer</button>
        </div>
      </div>
      <pre class="llm-console-body" id="llmConsoleContent">En attente d‚Äôune g√©n√©ration IA‚Ä¶</pre>
    </div>
  </div>

  <div id="modal">
    <div class="modal-card">
      <div>
        <h3 id="modalTitle">G√©n√©ration en cours‚Ä¶</h3>
        <p id="modalStatus">Pr√©paration</p>
      </div>
      <div class="modal-progress"><div id="progressBar" class="modal-progress-bar"></div></div>
      <div id="modalResult" class="modal-result"></div>
      <div class="modal-actions"><button id="btnCloseModal">Fermer</button></div>
    </div>
  </div>

  <script>
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const mobileNav = document.querySelector('.mobile-nav');
    if (mobileMenuToggle && mobileNav) {
      mobileMenuToggle.addEventListener('click', () => {
        mobileMenuToggle.classList.toggle('active');
        mobileNav.classList.toggle('active');
      });
      document.querySelectorAll('.mobile-nav a').forEach(link => {
        link.addEventListener('click', () => {
          mobileMenuToggle.classList.remove('active');
          mobileNav.classList.remove('active');
        });
      });
      document.addEventListener('click', (e) => {
        if (!mobileMenuToggle.contains(e.target) && !mobileNav.contains(e.target)) {
          mobileMenuToggle.classList.remove('active');
          mobileNav.classList.remove('active');
        }
      });
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        const targetId = this.getAttribute('href');
        if (targetId === '#') return;
        const target = document.querySelector(targetId);
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    function updateActiveMenuItem() {
      const sections = document.querySelectorAll('section[id]');
      const navLinks = document.querySelectorAll('.nav-links a, .mobile-nav a');
      let currentSection = '';
      const scrollPos = window.pageYOffset + 120;
      sections.forEach(section => {
        const top = section.offsetTop;
        const height = section.offsetHeight;
        if (scrollPos >= top && scrollPos < top + height) {
          currentSection = '#' + section.id;
        }
      });
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === currentSection) {
          link.classList.add('active');
        }
      });
    }
    window.addEventListener('scroll', updateActiveMenuItem);
    window.addEventListener('load', updateActiveMenuItem);

    window.addEventListener('scroll', () => {
      const header = document.querySelector('header');
      if (!header) return;
      const scrolled = window.pageYOffset;
      if (scrolled > 60) { header.classList.add('scrolled'); } else { header.classList.remove('scrolled'); }
    });

    window.addEventListener('scroll', () => {
      const shapes = document.querySelectorAll('.shape');
      const scrolled = window.pageYOffset;
      shapes.forEach((shape, index) => {
        const speed = (index + 1) * 0.25;
        shape.style.transform = `translateY(${scrolled * speed}px) rotate(${scrolled * 0.08}deg)`;
      });
    });

    const neuralLines = document.querySelectorAll('.neural-line');
    if (neuralLines.length) {
      setInterval(() => {
        neuralLines.forEach((line, index) => {
          setTimeout(() => {
            line.style.animation = 'neuralPulse 1.8s ease';
            setTimeout(() => { line.style.animation = ''; }, 1800);
          }, index * 260);
        });
      }, 2200);
    }

    function createQuantumParticle() {
      const particle = document.createElement('div');
      particle.style.position = 'fixed';
      particle.style.width = Math.random() * 4 + 1 + 'px';
      particle.style.height = particle.style.width;
      const palette = ['#00ffff', '#ff0080', '#8000ff'];
      const color = palette[Math.floor(Math.random() * palette.length)];
      particle.style.background = color;
      particle.style.borderRadius = '50%';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = '100vh';
      particle.style.pointerEvents = 'none';
      particle.style.zIndex = '-1';
      particle.style.boxShadow = `0 0 12px ${color}`;
      document.body.appendChild(particle);
      const duration = Math.random() * 3000 + 2500;
      const drift = (Math.random() - 0.5) * 200;
      particle.animate([
        { transform: 'translateY(0px) translateX(0px)', opacity: 0 },
        { transform: `translateY(-105vh) translateX(${drift}px)`, opacity: 1 }
      ], { duration, easing: 'ease-out' }).onfinish = () => particle.remove();
    }
    setInterval(createQuantumParticle, 1600);

    const observerOptions = { threshold: 0.12, rootMargin: '0px 0px -50px 0px' };
    const revealObserver = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, observerOptions);
    document.querySelectorAll('.hexagon').forEach(el => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(40px)';
      revealObserver.observe(el);
    });

    const $ = (id) => document.getElementById(id);
    const resultStatusEl = $('resultStatus');
    const resultHistoryEl = $('resultHistory');
    const resultPreviewEl = $('resultPreview');
    const generationProgressEl = $('generationProgress');
    const generationProgressMessageEl = $('generationProgressMessage');
    const generationProgressPercentEl = $('generationProgressPercent');
    const generationProgressFillEl = $('generationProgressFill');
    const generationProgressBarEl = $('generationProgressBar');
    const costLogLinkEl = $('costLogLink');
    const filesHintEl = $('filesHint');
    const icamLogoEls = Array.from(document.querySelectorAll('[data-icam-logo]'));
    const llmConsoleEl = $('llmConsole');
    const llmConsoleContentEl = $('llmConsoleContent');
    const llmConsoleDocLinkEl = $('llmConsoleDocLink');
    const llmConsoleCloseEl = $('llmConsoleClose');
    const llmConsoleTriggers = Array.from(document.querySelectorAll('[data-open-llm-console]'));
    const PROMPT_TOKEN_LIMIT = 100000; // FIX: Limite client pour bloquer les prompts trop volumineux.
    const PROMPT_STATIC_TOKEN_OVERHEAD = 2500; // FIX: Approximation des instructions syst√®me pour l'estimation des tokens.
    const promptEstimateFieldKeys = ['titre','entrepriseNom','ia_probleme','ia_solution','ia_objectifs','thematique','dureeProjet','contexte','demarche','phases','phrase']; // FIX: Liste des champs pris en compte dans l'estimateur local.
    const actionButtonsContainer = document.querySelector('.action-buttons'); // FIX: Cible le conteneur des boutons d'action pour injecter le bouton de retry.
    const tokenEstimateBadge = document.createElement('p'); // FIX: Pr√©pare l'indicateur visuel de tokens c√¥t√© UI.
    tokenEstimateBadge.id = 'tokenEstimate'; // FIX: Donne un identifiant pour faciliter les mises √† jour.
    tokenEstimateBadge.textContent = 'Estimation prompt ‚âà ‚Äî tokens (limite 100000)'; // FIX: Texte par d√©faut avant calcul.
    tokenEstimateBadge.style.fontSize = '0.85rem'; // FIX: Style discret pour l'indicateur de tokens.
    tokenEstimateBadge.style.opacity = '0.8'; // FIX: Maintient un aspect secondaire.
    tokenEstimateBadge.style.marginTop = '6px'; // FIX: Ajoute un espacement avec le statut.
    tokenEstimateBadge.style.display = 'block'; // FIX: Force l'affichage en bloc sous le statut en direct.
    if (resultStatusEl && resultStatusEl.parentElement) { // FIX: V√©rifie l'existence du conteneur avant d'injecter l'indicateur.
      resultStatusEl.parentElement.appendChild(tokenEstimateBadge); // FIX: Ajoute l'estimation de tokens sous le statut en direct.
    } // FIX: Termine l'injection de l'indicateur de tokens.
    let retryButton = null; // FIX: D√©clare le bouton de retry pour la gestion offline/rate-limit.
    if (actionButtonsContainer) { // FIX: N'ins√®re le bouton que si la zone d'action existe.
      retryButton = document.createElement('button'); // FIX: Cr√©e dynamiquement le bouton de retry.
      retryButton.type = 'button'; // FIX: Emp√™che la soumission du formulaire.
      retryButton.id = 'btnRetry'; // FIX: Ajoute un identifiant pour les tests et l'accessibilit√©.
      retryButton.textContent = '‚Üª R√©essayer'; // FIX: Libell√© explicite pour relancer la g√©n√©ration.
      retryButton.style.marginLeft = '12px'; // FIX: Ajoute un espacement par rapport au bouton principal.
      retryButton.style.padding = '14px 26px'; // FIX: Reproduit une ergonomie proche du bouton principal.
      retryButton.style.borderRadius = '999px'; // FIX: Harmonise avec le style n√©omorphique existant.
      retryButton.style.border = '1px solid rgba(255,255,255,0.4)'; // FIX: Donne un rendu secondaire sans √©diter le CSS global.
      retryButton.style.background = 'rgba(0,0,0,0.2)'; // FIX: Maintient un contraste discret pour ce bouton secondaire.
      retryButton.style.color = '#ffffff'; // FIX: Garantit la lisibilit√© du texte.
      retryButton.style.display = 'none'; // FIX: Masque le bouton tant qu'aucune erreur n'impose un retry.
      retryButton.style.cursor = 'pointer'; // FIX: Indique que l'action est cliquable.
      actionButtonsContainer.appendChild(retryButton); // FIX: Ins√®re le bouton directement √† c√¥t√© de l'action principale.
    } // FIX: Fin de l'insertion conditionnelle du bouton de retry.
    let retryUnlockTimer = null; // FIX: Sert √† retarder la r√©activation du bouton apr√®s un rate limit ou offline.
    function collectPromptFieldSnapshot() { // FIX: Centralise la lecture brute des champs utiles √† l'estimation.
      const snapshot = {}; // FIX: Pr√©pare la structure retourn√©e.
      promptEstimateFieldKeys.forEach((key) => { // FIX: Parcourt l'ensemble des champs surveill√©s.
        const el = $('f_' + key); // FIX: R√©utilise le helper pour pointer chaque input.
        snapshot[key] = el ? el.value || '' : ''; // FIX: Capture la valeur actuelle ou une cha√Æne vide.
      }); // FIX: Termine la boucle de collecte des champs.
      return snapshot; // FIX: Retourne le snapshot pour les calculs de tokens.
    } // FIX: Fin du collecteur de champs d'estimation.
    function computePromptStats(data) { // FIX: Convertit la longueur des champs en estimation de tokens.
      const parts = promptEstimateFieldKeys.map((key) => (data && data[key] ? String(data[key]) : '')); // FIX: Concat√®ne les champs surveill√©s dans un tableau homog√®ne.
      const approxTokens = Math.ceil((parts.join('\n').length + PROMPT_STATIC_TOKEN_OVERHEAD) / 4); // FIX: Conversion chars‚Üítokens (‚âà4 chars/token) avec marge syst√®me.
      let severity = 'ok'; // FIX: Niveau par d√©faut tant que la limite n'est pas approch√©e.
      if (approxTokens > PROMPT_TOKEN_LIMIT) severity = 'block'; // FIX: D√©clenche le blocage si la limite est d√©pass√©e.
      else if (approxTokens > PROMPT_TOKEN_LIMIT * 0.9) severity = 'warn'; // FIX: Signale un d√©passement imminent pour pr√©venir l'utilisateur.
      return { tokens: approxTokens, severity }; // FIX: Retourne √† la fois la valeur num√©rique et le niveau de gravit√©.
    } // FIX: Termine le calculateur de tokens c√¥t√© client.
    function refreshPromptEstimateBadge() { // FIX: Met √† jour l'indicateur visuel d√®s que le brief √©volue.
      if (!tokenEstimateBadge) return { tokens: 0, severity: 'ok' }; // FIX: S√©curise l'appel lorsque l'√©l√©ment est introuvable.
      const snapshot = collectPromptFieldSnapshot(); // FIX: R√©cup√®re les derni√®res valeurs saisies.
      const stats = computePromptStats(snapshot); // FIX: Convertit ces valeurs en estimation de tokens.
      tokenEstimateBadge.textContent = `Estimation prompt ‚âà ${stats.tokens} tokens (limite ${PROMPT_TOKEN_LIMIT})`; // FIX: Affiche le total estim√© dans l'UI.
      tokenEstimateBadge.style.color = stats.severity === 'block' ? '#ff6b6b' : stats.severity === 'warn' ? '#ffd166' : '#9ae6b4'; // FIX: Code couleur rapide selon la gravit√©.
      return stats; // FIX: Permet de r√©utiliser la derni√®re estimation dans d'autres fonctions.
    } // FIX: Fin de la mise √† jour de l'indicateur de tokens.
    function toggleRetryButton(show, { delayMs = 0, helperText = '' } = {}) { // FIX: Contr√¥le l'affichage du bouton de retry en fonction du type d'erreur.
      if (!retryButton) return; // FIX: S√©curise le cas o√π aucun bouton n'a √©t√© inject√©.
      if (!show) { // FIX: Masque et r√©initialise lorsque tout est revenu √† la normale.
        retryButton.style.display = 'none'; // FIX: Cache le bouton de retry.
        retryButton.disabled = false; // FIX: Supprime un √©ventuel √©tat d√©sactiv√©.
        retryButton.textContent = '‚Üª R√©essayer'; // FIX: Restaure le libell√© par d√©faut.
        retryButton.removeAttribute('title'); // FIX: Nettoie les infos bulles obsol√®tes.
        if (retryUnlockTimer) { clearTimeout(retryUnlockTimer); retryUnlockTimer = null; } // FIX: Annule les timers restants pour √©viter des effets de bord.
        return; // FIX: Termine lorsqu'on veut simplement masquer le bouton.
      }
      retryButton.style.display = 'inline-flex'; // FIX: Rend le bouton visible √† c√¥t√© de l'action principale.
      if (helperText) retryButton.title = helperText; else retryButton.removeAttribute('title'); // FIX: Informe l'utilisateur du motif du retry conseill√©.
      if (delayMs > 0) { // FIX: G√®re les cas rate limit/offline avec d√©lai conseill√©.
        retryButton.disabled = true; // FIX: Emp√™che un clic pr√©matur√© pendant le cooldown recommand√©.
        retryButton.textContent = `‚Üª Patientez ${Math.ceil(delayMs / 1000)}s`; // FIX: Affiche le compteur approximatif en secondes.
        if (retryUnlockTimer) { clearTimeout(retryUnlockTimer); } // FIX: √âvite plusieurs timers concurrents.
        retryUnlockTimer = setTimeout(() => { // FIX: Programme la r√©activation automatique apr√®s le d√©lai sugg√©r√©.
          retryButton.disabled = false; // FIX: Autorise √† nouveau l'utilisateur √† relancer.
          retryButton.textContent = '‚Üª R√©essayer'; // FIX: Restaure le libell√© normal apr√®s le cooldown.
          retryUnlockTimer = null; // FIX: Lib√®re la r√©f√©rence pour les prochains cycles.
        }, delayMs);
      } else {
        retryButton.disabled = false; // FIX: Permet un retry imm√©diat lorsqu'aucun d√©lai n'est impos√©.
        retryButton.textContent = '‚Üª R√©essayer'; // FIX: Laisse le bouton pr√™t √† l'emploi.
      }
    } // FIX: Fin du contr√¥leur d'affichage du bouton de retry.
    const promptWatcherIds = promptEstimateFieldKeys.map((key) => 'f_' + key); // FIX: Pr√©pare la liste des inputs √† surveiller pour l'estimation.
    promptWatcherIds.forEach((inputId) => { // FIX: Ajoute les √©couteurs sur chaque champ critique.
      const el = $(inputId); // FIX: R√©cup√®re l'√©l√©ment correspondant √† l'identifiant g√©n√©r√©.
      if (!el) return; // FIX: Ignore les champs absents pour √©viter les erreurs.
      el.addEventListener('input', () => refreshPromptEstimateBadge()); // FIX: Met √† jour l'indicateur d√®s la saisie.
      el.addEventListener('change', () => refreshPromptEstimateBadge()); // FIX: Couvre aussi les modifications non saisies (coller, auto-fill).
    });
    refreshPromptEstimateBadge(); // FIX: Initialise l'indicateur d√®s le chargement de la console.
    let lastLlmConsoleText = '';
    let lastLlmConsoleDocUrl = '';
    const generationProgress = (() => {
      if (!generationProgressEl) {
        const noop = () => {};
        return { start: noop, step: noop, settle: noop, fail: noop, reset: noop };
      }

      let timer = null;
      let manualPct = 0;
      let finished = false;
      let startedAt = 0;
      let estimatedMs = 15000;

      function setVisibility(show) {
        generationProgressEl.classList.toggle('is-active', !!show);
        generationProgressEl.setAttribute('aria-hidden', show ? 'false' : 'true');
      }

      function updateFill(pct) {
        const bounded = Math.max(0, Math.min(100, Number(pct) || 0));
        if (generationProgressFillEl) {
          generationProgressFillEl.style.width = bounded + '%';
        }
        if (generationProgressPercentEl) {
          generationProgressPercentEl.textContent = Math.round(bounded) + '%';
        }
        if (generationProgressBarEl) {
          generationProgressBarEl.setAttribute('aria-valuenow', String(Math.round(bounded)));
        }
        return bounded;
      }

      function clearTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }

      function ensureTimer() {
        if (timer) return;
        timer = setInterval(() => {
          if (finished) {
            clearTimer();
            return;
          }
          if (!estimatedMs) return;
          const elapsed = Date.now() - startedAt;
          const autoPct = Math.min(99, (elapsed / estimatedMs) * 100);
          const target = Math.max(manualPct, autoPct);
          updateFill(target);
        }, 180);
      }

      function applyEstimate(ms) {
        if (!ms || ms <= 0) return;
        estimatedMs = Math.max(ms, 4000);
      }

      return {
        start({ message, estimatedMs: eta } = {}) {
          startedAt = Date.now();
          manualPct = 0;
          finished = false;
          applyEstimate(eta || estimatedMs);
          updateFill(0);
          if (generationProgressMessageEl) {
            generationProgressMessageEl.textContent = message || 'Pr√©paration de la g√©n√©ration‚Ä¶';
          }
          setVisibility(true);
          clearTimer();
          ensureTimer();
        },
        step({ message, pct, estimatedMs: eta } = {}) {
          if (finished) return;
          if (eta) applyEstimate(eta);
          if (typeof pct === 'number' && !isNaN(pct)) {
            manualPct = Math.max(manualPct, Math.min(99, pct));
            updateFill(manualPct);
          }
          if (message && generationProgressMessageEl) {
            generationProgressMessageEl.textContent = message;
          }
          ensureTimer();
        },
        settle({ message, latencyMs, delay = 1500 } = {}) {
          if (finished) return;
          finished = true;
          clearTimer();
          const basePct = Math.max(manualPct, 92);
          let current = updateFill(basePct);
          if (message && generationProgressMessageEl) {
            generationProgressMessageEl.textContent = message;
          }
          const finalLatency = latencyMs && latencyMs > 0 ? latencyMs : estimatedMs || 5000;
          const steps = 5;
          const increment = (100 - basePct) / steps;
          let stepIndex = 0;
          const settleTimer = setInterval(() => {
            stepIndex++;
            current = updateFill(current + increment);
            if (stepIndex >= steps) {
              clearInterval(settleTimer);
              updateFill(100);
              setTimeout(() => setVisibility(false), delay);
            }
          }, Math.max(90, finalLatency / (steps * 2)));
        },
        fail({ message, delay = 2200 } = {}) {
          finished = true;
          clearTimer();
          if (message && generationProgressMessageEl) {
            generationProgressMessageEl.textContent = message;
          }
          updateFill(100);
          setTimeout(() => setVisibility(false), delay);
        },
        reset() {
          finished = false;
          clearTimer();
          manualPct = 0;
          updateFill(0);
          if (generationProgressMessageEl) {
            generationProgressMessageEl.textContent = '';
          }
          setVisibility(false);
        },
      };
    })();
    function getRunner() {
      return (typeof google !== 'undefined' && google.script && google.script.run)
        ? google.script.run
        : null;
    }
    function updateDictStatus(targetId, message) {
      if (!targetId) return;
      const statusEl = document.querySelector(`[data-dict-status="${targetId}"]`);
      if (statusEl) statusEl.textContent = message;
    }
    function resetAllDictStatus(message = 'Pr√™t.') {
      document.querySelectorAll('.dict-status').forEach((el) => {
        el.textContent = message;
      });
    }
    function formatLlmConsoleText(raw) {
      if (!raw) return '';
      try {
        return JSON.stringify(JSON.parse(raw), null, 2);
      } catch (_) {
        return raw;
      }
    }
    function updateConsoleDocLink(url) {
      if (!llmConsoleDocLinkEl) return;
      if (url) {
        llmConsoleDocLinkEl.href = url;
        llmConsoleDocLinkEl.classList.remove('is-disabled');
        llmConsoleDocLinkEl.setAttribute('aria-disabled', 'false');
      } else {
        llmConsoleDocLinkEl.href = '#';
        llmConsoleDocLinkEl.classList.add('is-disabled');
        llmConsoleDocLinkEl.setAttribute('aria-disabled', 'true');
      }
    }
    function toggleConsoleTriggers(enabled) {
      llmConsoleTriggers.forEach((btn) => {
        btn.disabled = !enabled;
        btn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      });
    }
    toggleConsoleTriggers(false);
    function showLlmConsole(content, docUrl) {
      if (!llmConsoleEl || !llmConsoleContentEl) return;
      llmConsoleContentEl.textContent = content && content.trim()
        ? formatLlmConsoleText(content)
        : 'Aucun transcript disponible.';
      updateConsoleDocLink(docUrl);
      llmConsoleEl.classList.add('active');
      llmConsoleEl.setAttribute('aria-hidden', 'false');
    }
    function hideLlmConsoleOverlay() {
      if (!llmConsoleEl) return;
      llmConsoleEl.classList.remove('active');
      llmConsoleEl.setAttribute('aria-hidden', 'true');
    }
    if (llmConsoleCloseEl) {
      llmConsoleCloseEl.addEventListener('click', hideLlmConsoleOverlay);
    }
    if (llmConsoleEl) {
      llmConsoleEl.addEventListener('click', (event) => {
        if (event.target === llmConsoleEl) hideLlmConsoleOverlay();
      });
    }
    llmConsoleTriggers.forEach((btn) => {
      btn.addEventListener('click', () => {
        if (!btn.disabled) {
          showLlmConsole(lastLlmConsoleText, lastLlmConsoleDocUrl);
        }
      });
    });
    function updateCostLogLink(url) {
      if (!costLogLinkEl || !url) return;
      costLogLinkEl.href = url;
      costLogLinkEl.classList.remove('is-disabled');
      costLogLinkEl.setAttribute('aria-disabled', 'false');
    }
    function updatePreview(text) {
      if (!resultPreviewEl) return;
      resultPreviewEl.textContent = text && text.trim()
        ? text
        : 'Pr√™t √† compiler les informations du brief.';
    }
    function buildFormPreview(data) {
      if (!data) return 'Brief non renseign√©.';
      const lines = [
        `Titre : ${data.titre || '‚Äî'}`,
        `Entreprise : ${data.entrepriseNom || '‚Äî'}`,
        `Probl√®me : ${data.ia_probleme || '‚Äî'}`,
        `Solution : ${data.ia_solution || '‚Äî'}`,
        `Objectifs : ${data.ia_objectifs || '‚Äî'}`,
        `Dur√©e : ${data.dureeProjet || '‚Äî'}`
      ];
      return lines.join('\n');
    }
    function buildAiPreview(sections, docUrl) {
      if (!sections) return 'Aucune section g√©n√©r√©e pour le moment.';
      const parts = [];
      if (sections.contexte) parts.push(`Contexte\n${sections.contexte}`);
      if (sections.demarche) parts.push(`D√©marche\n${sections.demarche}`);
      if (sections.phases) parts.push(`Phases\n${sections.phases}`);
      if (sections.phrase) parts.push(`Phrase de cl√¥ture\n${sections.phrase}`);
      if (docUrl) parts.push(`Document : ${docUrl}`);
      return parts.length ? parts.join('\n\n') : 'Sections g√©n√©r√©es disponibles dans le document.';
    }
    function appendLog(message) {
      const logEl = $('f_log');
      if (!logEl) return;
      const now = new Date();
      const timeLabel = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const line = `[${timeLabel}] ${message}`;
      logEl.value = logEl.value ? `${logEl.value}\n${line}` : line;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function updateResultPanel({ state = 'idle', message = '', link = '', linkLabel = 'Ouvrir', recordHistory = true } = {}) {
      if (resultStatusEl && message) {
        resultStatusEl.className = `result-status is-${state}`;
        resultStatusEl.innerHTML = '';
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        resultStatusEl.appendChild(textSpan);
        if (link) {
          const anchor = document.createElement('a');
          anchor.href = link;
          anchor.target = '_blank';
          anchor.rel = 'noopener';
          anchor.textContent = linkLabel || 'Ouvrir';
          resultStatusEl.appendChild(anchor);
        }
      }
      if (recordHistory && resultHistoryEl && message) {
        const placeholder = resultHistoryEl.querySelector('[data-placeholder="true"]');
        if (placeholder) placeholder.remove();
        const timestamp = new Date();
        const timeLabel = timestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const item = document.createElement('li');
        item.className = `result-item is-${state}`;
        const span = document.createElement('span');
        span.textContent = message;
        const time = document.createElement('time');
        time.setAttribute('datetime', timestamp.toISOString());
        time.textContent = timeLabel;
        item.append(span, time);
        resultHistoryEl.prepend(item);
        const entries = resultHistoryEl.querySelectorAll('li');
        if (entries.length > 5) {
          Array.from(entries)
            .slice(5)
            .forEach((entry) => entry.remove());
        }
      }
    }
    function showModal(title, status, pct = 0) {
      $('modalTitle').textContent = title;
      $('modalStatus').textContent = status;
      $('progressBar').style.width = pct + '%';
      $('modalResult').innerHTML = '';
      $('btnCloseModal').style.display = 'none';
      $('modal').classList.add('active');
    }
    function hideModal() { $('modal').classList.remove('active'); }
    const decimalFields = new Set(['llmTemperature', 'llmTopP']);
    const integerFields = new Set(['llmMaxTokens']);
    const rawFields = new Set(['log']);
    function collectForm() {
      const fields = ['titre','codeProjet','dateDebut','versionDoc','dureeProjet','thematique','entrepriseNom','entrepriseAdresse','clientNom','clientFonction','clientEmail','clientTelephone','entrepriseLogo','ia_probleme','ia_solution','ia_objectifs','contexte','demarche','phases','phrase','deepseekModel','llmTemperature','llmTopP','llmMaxTokens','journalHorodatage','journalType','journalCours','log'];
      const out = {};
      fields.forEach(f => {
        const el = $('f_' + f);
        if (!el) {
          out[f] = '';
          return;
        }
        const raw = el.value ?? '';
        if (rawFields.has(f)) {
          out[f] = raw;
          return;
        }
        const trimmed = typeof raw === 'string' ? raw.trim() : raw;
        if (decimalFields.has(f)) {
          const numeric = parseFloat(String(trimmed).replace(',', '.'));
          out[f] = Number.isFinite(numeric) ? numeric : null;
          return;
        }
        if (integerFields.has(f)) {
          const numeric = parseInt(String(trimmed), 10);
          out[f] = Number.isFinite(numeric) ? numeric : null;
          return;
        }
        out[f] = trimmed;
      });

      if (!out.deepseekModel) out.deepseekModel = 'deepseek-reasoner';
      if (!out.journalType) out.journalType = 'generation';

      if (out.journalHorodatage) {
        const parsed = new Date(out.journalHorodatage);
        if (!Number.isNaN(parsed.getTime())) {
          out.journalHorodatage = parsed.toISOString();
        }
      } else {
        const now = new Date();
        const localIso = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        const input = $('f_journalHorodatage');
        if (input && !input.value) input.value = localIso;
        out.journalHorodatage = now.toISOString();
      }
      return out;
    }
    let speechRecognition = null;
    let dictationActive = false;
    let dictationStopping = false;
    let dictationTarget = null;
    let dictationButton = null;
    let pendingDictation = null;

    function initSpeechDictation() {
      const dictationButtons = Array.from(document.querySelectorAll('[data-dict-target]'));
      if (!dictationButtons.length) return;

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        dictationButtons.forEach((btn) => {
          btn.disabled = true;
          btn.classList.add('is-disabled');
        });
        appendLog('Dict√©e vocale non support√©e par ce navigateur.');
        resetAllDictStatus('Dict√©e non support√©e.');
        return;
      }

      dictationButtons.forEach((btn) => {
        if (!btn.dataset.originalLabel) {
          btn.dataset.originalLabel = btn.textContent.trim();
        }
      });

      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = 'fr-FR';
      speechRecognition.continuous = true;
      speechRecognition.interimResults = true;

      speechRecognition.onresult = (event) => {
        if (!dictationTarget) return;
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          if (!result || !result[0]) continue;
          const transcript = (result[0].transcript || '').trim();
          if (!transcript) continue;
          if (result.isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            updateDictStatus(dictationTarget.id, `‚Ä¶ ${transcript}`);
          }
        }
        finalTranscript = finalTranscript.trim();
        if (!finalTranscript) return;
        const current = dictationTarget.value || '';
        const separator = current && !(/[\s\n]$/.test(current)) ? ' ' : '';
        dictationTarget.value = current + separator + finalTranscript;
        dictationTarget.dispatchEvent(new Event('input', { bubbles: true }));
        updateDictStatus(dictationTarget.id, 'OK ‚úì');
        appendLog(`Dict√©e ‚Üí ${finalTranscript}`);
      };

      speechRecognition.onerror = (event) => {
        appendLog(`Erreur dict√©e: ${event.error || 'inconnue'}`);
        dictationStopping = true;
        dictationActive = false;
        if (dictationTarget) updateDictStatus(dictationTarget.id, `Erreur : ${event.error || 'inconnue'}`);
        try {
          speechRecognition.stop();
        } catch (_) {}
      };

      speechRecognition.onstart = () => {
        dictationActive = true;
        dictationStopping = false;
        if (dictationButton) {
          dictationButton.classList.add('is-active');
          dictationButton.textContent = 'üõë Arr√™ter';
        }
        if (dictationTarget) updateDictStatus(dictationTarget.id, '√âcoute en cours‚Ä¶');
        appendLog('Dict√©e vocale d√©marr√©e.');
      };

      speechRecognition.onend = () => {
        const previousButton = dictationButton;
        const previousTarget = dictationTarget ? dictationTarget.id : null;
        if (previousButton) {
          previousButton.classList.remove('is-active');
          previousButton.textContent = previousButton.dataset.originalLabel || 'üéôÔ∏è Dicter';
        }

        const nextRequest = pendingDictation;
        pendingDictation = null;
        dictationActive = false;
        const wasStopping = dictationStopping;
        dictationStopping = false;

        if (nextRequest) {
          dictationTarget = nextRequest.target;
          dictationButton = nextRequest.button;
          requestAnimationFrame(() => {
            try {
              speechRecognition.start();
            } catch (err) {
              appendLog(`Impossible de d√©marrer la dict√©e: ${err.message || err}`);
              updateDictStatus(dictationTarget.id, 'D√©marrage impossible.');
            }
          });
          return;
        }

        if (!wasStopping && previousTarget) {
          updateDictStatus(previousTarget, 'Pr√™t.');
          appendLog('Dict√©e interrompue.');
        }
        dictationTarget = null;
        dictationButton = null;
      };

      function requestDictation(target, button) {
        dictationTarget = target;
        dictationButton = button;
        try {
          speechRecognition.start();
        } catch (err) {
          appendLog(`Impossible de d√©marrer la dict√©e: ${err.message || err}`);
          updateDictStatus(dictationTarget.id, 'D√©marrage impossible.');
        }
      }

      function stopDictation() {
        if (!speechRecognition) return;
        dictationStopping = true;
        if (dictationTarget) updateDictStatus(dictationTarget.id, 'Arr√™t en cours‚Ä¶');
        try {
          speechRecognition.stop();
        } catch (_) {}
      }

      dictationButtons.forEach((button) => {
        button.addEventListener('click', () => {
          if (!speechRecognition) return;
          const target = document.getElementById(button.dataset.dictTarget);
          if (!target) return;

          if (!dictationActive) {
            requestDictation(target, button);
            return;
          }

          if (dictationButton === button) {
            stopDictation();
            appendLog('Dict√©e arr√™t√©e par l‚Äôutilisateur.');
            return;
          }

          pendingDictation = { target, button };
          stopDictation();
        });
      });

      resetAllDictStatus();
      appendLog('Dict√©e vocale pr√™te.');
    }

    document.addEventListener('focusin', (event) => {
      const target = event.target;
      if (!target || dictationActive) return;
      if (target.matches('textarea, input[type="text"], input[type="search"], input[type="email"], input[type="tel"], input[type="url"], input[type="number"]')) {
        dictationTarget = target;
      }
    });

    appendLog('Console initialis√©e.');
    updatePreview('Pr√™t √† compiler les informations du brief.');
    updateResultPanel({ state: 'idle', message: 'Pr√™t pour une nouvelle g√©n√©ration.', recordHistory: false });
    dictationTarget = $('f_contexte') || null;
    initSpeechDictation();

    const attachmentsInput = $('f_attachments');
    if (attachmentsInput) {
      const configuredMax = parseInt(attachmentsInput.getAttribute('data-max') || '15', 10);
      const maxFiles = Number.isFinite(configuredMax) ? Math.max(1, configuredMax) : 15;
      const updateFilesHint = (count) => {
        if (!filesHintEl) return;
        if (!count) {
          filesHintEl.textContent = `Aucun fichier s√©lectionn√© (0/${maxFiles}).`;
          return;
        }
        filesHintEl.textContent = `${count}/${maxFiles} fichier(s) s√©lectionn√©(s).`;
      };
      updateFilesHint(0);
      attachmentsInput.addEventListener('change', () => {
        const files = Array.from(attachmentsInput.files || []);
        if (files.length > maxFiles) {
          alert(`Jusqu‚Äô√† ${maxFiles} fichiers.`);
          attachmentsInput.value = '';
          updateFilesHint(0);
          appendLog('S√©lection trop importante de pi√®ces jointes.');
          return;
        }
        updateFilesHint(files.length);
        appendLog(files.length
          ? `Pi√®ces jointes s√©lectionn√©es: ${files.length}`
          : 'Aucune pi√®ce jointe s√©lectionn√©e.');
      });
    }

    const initRunner = getRunner();
    if (icamLogoEls.length) {
      const applyLogo = (url) => {
        if (!url) return;
        icamLogoEls.forEach((el) => {
          el.src = url;
        });
      };
      if (initRunner) {
        initRunner.withSuccessHandler(applyLogo).getIcamLogoDataUrl();
      } else {
        icamLogoEls.forEach((el) => {
          const fallback = el.getAttribute('data-fallback-logo');
          if (fallback) el.src = fallback;
        });
      }
    }
    if (costLogLinkEl && initRunner) {
      initRunner.withSuccessHandler(updateCostLogLink).getCostLogUrl_public();
    }

    const btnGenerate = $('btnGenerate'); // FIX: R√©cup√®re le bouton principal de g√©n√©ration pour g√©rer la logique avanc√©e.
    if (retryButton && btnGenerate) { // FIX: Relie le bouton de retry au flux principal.
      retryButton.addEventListener('click', () => { // FIX: Permet un retry manuel explicite.
        if (retryButton.disabled) return; // FIX: Emp√™che les relances pendant le cooldown conseill√©.
        btnGenerate.click(); // FIX: R√©utilise la m√™me logique que le bouton principal.
      });
    }
    if (btnGenerate) { // FIX: V√©rifie que le bouton existe avant d'ajouter la logique renforc√©e.
      btnGenerate.addEventListener('click', async () => { // FIX: Surveille chaque clic pour appliquer les nouvelles validations.
        const fd = collectForm(); // FIX: Capture l'√©tat complet du formulaire avant validations suppl√©mentaires.
        const missing = []; // FIX: Initialise la liste des champs obligatoires manquants.
        if (!fd.titre) missing.push('Le titre est obligatoire'); // FIX: Garantit que le titre est fourni avant l'appel API.
        if (!fd.entrepriseNom) missing.push('Le nom de l‚Äôentreprise est obligatoire'); // FIX: Rappelle la contrainte sur le nom client.
        if (!fd.ia_probleme) missing.push('Le probl√®me principal est obligatoire'); // FIX: Emp√™che un prompt incomplet c√¥t√© DeepSeek.
        if (missing.length) { // FIX: Arr√™te la g√©n√©ration si des champs critiques sont absents.
          alert('‚ö†Ô∏è Merci de corriger :\n\n' + missing.join('\n')); // FIX: Affiche la liste des corrections attendues.
          return; // FIX: Emp√™che tout appel API tant que le formulaire est incomplet.
        } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.

        // Traitement des pi√®ces jointes
        const attachmentsInput = $('f_attachments');
        if (attachmentsInput && attachmentsInput.files && attachmentsInput.files.length > 0) {
           const files = Array.from(attachmentsInput.files);
           const readFile = (file) => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve({
                  name: file.name,
                  mimeType: file.type,
                  bytes: reader.result.split(',')[1]
              });
              reader.onerror = reject;
              reader.readAsDataURL(file);
           });

           try {
             appendLog('Lecture des pi√®ces jointes...');
             fd.attachments = await Promise.all(files.map(readFile));
             appendLog(`${fd.attachments.length} pi√®ce(s) jointe(s) pr√™te(s).`);
           } catch (e) {
             alert("Erreur lors de la lecture des fichiers : " + e);
             return;
           }
        }

        // FIX: S√©parateur requis pour contextualiser la nouvelle logique UI.
        // FIX: S√©pare les validations du calcul d'estimation de tokens c√¥t√© client.
        toggleRetryButton(false); // FIX: R√©initialise l'√©tat du bouton de retry √† chaque lancement.
        const promptStats = computePromptStats(fd); // FIX: Utilise l'estimation locale avant d'appeler Apps Script.
        if (promptStats.severity === 'block') { // FIX: Bloque si la limite de 100k tokens est d√©pass√©e c√¥t√© client.
          const overflowMsg = `Brief trop long (~${promptStats.tokens} tokens). R√©duisez la saisie avant de relancer.`; // FIX: Message explicite pour l'utilisateur.
          alert(overflowMsg); // FIX: Met en √©vidence la contrainte directement c√¥t√© UI.
          updateResultPanel({ state: 'error', message: overflowMsg, recordHistory: true }); // FIX: Historise l'√©chec de validation.
          appendLog(overflowMsg); // FIX: Ajoute l'incident dans le log texte.
          return; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        } else if (promptStats.severity === 'warn') { // FIX: Informe l'utilisateur lorsqu'il s'approche de la limite.
          appendLog(`‚ö†Ô∏è Brief proche de la limite DeepSeek (~${promptStats.tokens} tokens).`); // FIX: Invite √† all√©ger le brief avant la prochaine g√©n√©ration.
        } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        // FIX: S√©parateur requis pour contextualiser la nouvelle logique UI.
        // FIX: Pr√©pare la console pour une nouvelle r√©ponse IA propre.
        lastLlmConsoleText = ''; // FIX: Efface tout transcript pr√©c√©dent pour √©viter les confusions.
        lastLlmConsoleDocUrl = ''; // FIX: Supprime l'ancien lien de transcript IA.
        toggleConsoleTriggers(false); // FIX: D√©sactive l'ouverture de la console tant que rien n'est g√©n√©r√©.
        updateConsoleDocLink(''); // FIX: Nettoie le lien de transcript dans l'UI.
        hideLlmConsoleOverlay(); // FIX: Ferme la console IA si elle √©tait affich√©e.
        generationProgress.start({ message: 'Pr√©paration de la g√©n√©ration‚Ä¶', estimatedMs: 18000 }); // FIX: Relance la barre de progression avec l'ETA.
        updatePreview(buildFormPreview(fd)); // FIX: Affiche un r√©sum√© du brief pendant la pr√©paration.
        appendLog('Pr√©paration de la g√©n√©ration DeepSeek.'); // FIX: Journalise l'√©tape courante pour audit.
        showModal('üöÄ Lancement', 'Estimation du co√ªt‚Ä¶', 12); // FIX: Informe l'utilisateur que l'estimation d√©bute.
        $('progressBar').style.width = '18%'; // FIX: Met √† jour la jauge visuelle du modal.
        updateResultPanel({ state: 'progress', message: 'Estimation du co√ªt‚Ä¶', recordHistory: true }); // FIX: Trace l'√©tat dans le panneau de statut.
        generationProgress.step({ message: 'Estimation du co√ªt‚Ä¶', pct: 14 }); // FIX: Synchronise la progression interne.
        // FIX: S√©parateur requis pour contextualiser la nouvelle logique UI.
        const runnerCheck = getRunner(); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        if (!runnerCheck) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          appendLog('google.script.run indisponible (mode hors Apps Script).'); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          setTimeout(() => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('modalStatus').textContent = 'Pr√©visualisation locale (Apps Script requis).'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('progressBar').style.width = '100%'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('modalResult').innerHTML = '<p>google.script.run non disponible hors Apps Script.</p>'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('btnCloseModal').style.display = 'inline-flex'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            updateResultPanel({ state: 'error', message: 'Pr√©visualisation locale uniquement (Apps Script requis).', recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          }, 600); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          generationProgress.fail({ message: 'Hors Apps Script ‚Äî progression arr√™t√©e.' }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          toggleRetryButton(true, { helperText: 'Relancez depuis Apps Script une fois le d√©ploiement effectu√©.' }); // FIX: Invite √† r√©essayer apr√®s d√©ploiement Apps Script.
          return; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        // FIX: S√©parateur requis pour contextualiser la nouvelle logique UI.
        const launchGeneration = () => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          appendLog('Transmission des donn√©es √† Apps Script.'); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          generationProgress.step({ message: 'Transmission des donn√©es √† Apps Script‚Ä¶', pct: 32 }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          $('modalStatus').textContent = 'G√©n√©ration du document‚Ä¶'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          $('progressBar').style.width = '55%'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          updateResultPanel({ state: 'progress', message: 'G√©n√©ration du document‚Ä¶', recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          generationProgress.step({ message: 'G√©n√©ration du document‚Ä¶', pct: 58 }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          const runnerGenerate = getRunner(); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          runnerGenerate // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            .withSuccessHandler(res => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              if (res && res.success) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                generationProgress.settle({ message: 'Document g√©n√©r√©', latencyMs: res.latencyMs }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                showModal('üéâ Succ√®s', 'Document cr√©√©', 100); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                const docUrl = res.url || ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                $('modalResult').innerHTML = docUrl ? `<a href="${docUrl}" target="_blank" rel="noopener">üìÑ Ouvrir le document</a>` : ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                const costMessage = (res.cost && typeof res.cost.total === 'number') // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  ? `Document g√©n√©r√© ‚Äî co√ªt $${res.cost.total.toFixed(4)}` // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  : 'Document g√©n√©r√©'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                updateResultPanel({ state: 'success', message: costMessage, link: docUrl, linkLabel: 'Ouvrir', recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (res.aiSections) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  updatePreview(buildAiPreview(res.aiSections, docUrl)); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                } else if (res.llmContent) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  updatePreview(res.llmContent); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (res.llmContent) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  lastLlmConsoleText = res.llmContent; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  lastLlmConsoleDocUrl = res.consoleDocUrl || ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  toggleConsoleTriggers(true); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  showLlmConsole(lastLlmConsoleText, lastLlmConsoleDocUrl); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (res.consoleDocUrl) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  updateConsoleDocLink(res.consoleDocUrl); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (res.costLogUrl) updateCostLogLink(res.costLogUrl); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                appendLog(docUrl ? `Succ√®s g√©n√©ration ¬∑ Doc: ${docUrl}` : 'Succ√®s g√©n√©ration (URL non transmise).'); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (res.cost && typeof res.cost.total === 'number') { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  appendLog(`Co√ªt DeepSeek factur√©: $${res.cost.total.toFixed(4)}`); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                if (typeof res.promptTokens === 'number' && tokenEstimateBadge) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                  tokenEstimateBadge.textContent = `Estimation prompt ‚âà ${res.promptTokens} tokens (limite ${PROMPT_TOKEN_LIMIT})`; // FIX: Aligne l'affichage sur la valeur renvoy√©e par Apps Script.
                  tokenEstimateBadge.style.color = '#9ae6b4'; // FIX: Colore en vert apr√®s succ√®s.
                } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                toggleRetryButton(false); // FIX: Masque l'action de retry apr√®s un succ√®s.
              } else { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                const errorMessage = (res && res.error) || 'Erreur inconnue'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                generationProgress.fail({ message: errorMessage }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                showModal('‚ùå Erreur', errorMessage, 0); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                updateResultPanel({ state: 'error', message: errorMessage, recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                appendLog(`Erreur g√©n√©ration: ${errorMessage}`); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                toggleConsoleTriggers(false); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                lastLlmConsoleText = ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                lastLlmConsoleDocUrl = ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                updateConsoleDocLink(''); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                const shouldOfferRetry = !!(res && (res.code === 'RATE_LIMIT' || res.code === 'OFFLINE')); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                const retryDelay = res && typeof res.retryAfterMs === 'number' ? Math.max(0, res.retryAfterMs) : 0; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
                toggleRetryButton(shouldOfferRetry, { delayMs: retryDelay, helperText: errorMessage }); // FIX: Informe l'utilisateur d'un retry conseill√©.
              } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              $('btnCloseModal').style.display = 'inline-flex'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            }) // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            .withFailureHandler(err => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const errorText = err && err.message ? err.message : String(err); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              generationProgress.fail({ message: errorText }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              showModal('‚ùå Erreur', errorText, 0); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              updateResultPanel({ state: 'error', message: errorText, recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              appendLog(`Erreur technique: ${errorText}`); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              $('btnCloseModal').style.display = 'inline-flex'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              toggleConsoleTriggers(false); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              lastLlmConsoleText = ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              lastLlmConsoleDocUrl = ''; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              updateConsoleDocLink(''); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              toggleRetryButton(true, { helperText: errorText }); // FIX: Offre un retry imm√©diat apr√®s une erreur Apps Script.
            }) // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            .generateFullProposal(fd); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        }; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
        // FIX: S√©parateur requis pour contextualiser la nouvelle logique UI.
        getRunner() // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          .withSuccessHandler(res => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            if (res && res.est) { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const est = res.est; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const total = typeof est.total === 'number' ? est.total.toFixed(4) : '‚Äî'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const inTok = est.input && typeof est.input.tokens === 'number' ? est.input.tokens : '‚Äî'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const outTok = est.output && typeof est.output.tokens === 'number' ? est.output.tokens : '‚Äî'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const model = est.model || 'DeepSeek'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const summary = `Estimation co√ªt: $${total} ¬∑ IN ${inTok} tok ¬∑ OUT ${outTok} tok ¬∑ Mod√®le: ${model}`; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              $('modalStatus').textContent = summary; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              $('progressBar').style.width = '38%'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              updateResultPanel({ state: 'progress', message: summary, recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              appendLog(summary); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              const etaMs = res.estimatedDurationMs || est.estimatedDurationMs; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              generationProgress.step({ message: summary, pct: 28, estimatedMs: etaMs }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
              if (res.sheetUrl) updateCostLogLink(res.sheetUrl); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            launchGeneration(); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          }) // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          .withFailureHandler(err => { // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            const msg = err && err.message ? err.message : 'Estimation indisponible.'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            appendLog(`Estimation indisponible: ${msg}`); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('modalStatus').textContent = 'Estimation indisponible, lancement direct‚Ä¶'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            $('progressBar').style.width = '32%'; // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            updateResultPanel({ state: 'progress', message: 'Estimation indisponible, lancement direct‚Ä¶', recordHistory: true }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            generationProgress.step({ message: 'Estimation indisponible, lancement direct‚Ä¶', pct: 22 }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
            launchGeneration(); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          }) // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
          .estimateAndLogCost_public(fd); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
      }); // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
    } // FIX: Renforce la validation et le fallback offline c√¥t√© interface.
    const closeBtn = $('btnCloseModal');
    if (closeBtn) {
      closeBtn.addEventListener('click', hideModal);
    }
    const modal = $('modal');
    if (modal) {
      modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
    }
  </script>
</body>
</html>
